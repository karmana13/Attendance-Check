import json
import boto3
from six.moves import urllib

def face_detection_from_collection(bucket,photo,collection_id):
    client= boto3.client('rekognition','us-east-1')
    reponse = client.search_faces_by_image(CollectionId = collection_id,
                                        Image = {'S3Object': {'Bucket':bucket,'Name':photo}},
                                        FaceMatchThreshold = 90,
                                        MaxFaces = 1)
    face_matches = response['FaceMatches']
    print('Matching Face:')
    for match in face_matches:
        print ('FaceId:' + match['Face']['FaceId'])
        print ('Similarity: ' + "{:.2f}".format(match['Similarity']) + "%")
        print
    
def lambda_handler(event, context):
    s3 = boto3.client('s3','us-east-1')
       # create_collection("test_collection")
    bucket= event['Records'][0]['s3']['bucket']['name']
    photo=urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'],encoding='utf-8')
    collection_id="test_collection"
    
    try:
        response = s3.list_objects_v2(Bucket = bucket, Prefix = 'public/detectimages')
        for object in response['Contents']:
            print(object)
            face_detection_from_collection(bucket,photo,collection_id)
            
    
        return {
        'statusCode': 200,
        'body': json.dumps(object)
        }
    except Exception as e:
        print(e)
        raise(e)
